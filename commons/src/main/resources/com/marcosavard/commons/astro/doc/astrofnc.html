<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head><meta content="text/html; charset=ISO-8859-1" http-equiv="content-type"><title>astrofnc</title></head><body><img src="http://www.stargazing.net/kepler/banner.gif" alt="" style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;" border="0" height="30" width="400"><span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;"></span>
<h1 style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-style: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;"><a name="twig00">User defined functions in Excel</a></h1>
<span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">[<span>&nbsp;</span></span><a href="http://www.stargazing.net/kepler/index.html" style="font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Root</a><span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;"><span>&nbsp;</span>]</span>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;"><tt><strong>Correction:</strong><span>&nbsp;</span>Thank's
to Yu Cheng Lai for pointing out an error in the position for Pluto.
The Pluto mean elements and the downloadable spreadsheet have now been
corrected - 27th Feb 1999</tt></p>
<h2 style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-style: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Contents</h2>
<ul style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">
<li><a href="http://www.stargazing.net/kepler/astrofnc.html#twig01">Overview</a></li><li><a href="http://www.stargazing.net/kepler/astrofnc.html#twig02">Excel VBA code</a></li><li><a href="http://www.stargazing.net/kepler/astrofnc.html#twig03">Download example spreadsheet</a></li><li><a href="http://www.stargazing.net/kepler/astrofnc.html#twig04">References</a></li>
</ul>
<h2 style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-style: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;"><a name="twig01">Overview</a></h2>
<span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">[</span><a href="http://www.stargazing.net/kepler/astrofnc.html#twig00" style="font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Top</a><span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">]</span>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">This
page provides details of a range of user functions for astronomy for
Microsoft Excel version 5 or later. These functions may also be of
interest to land surveyors and construction technicians, as well as
teachers of astronomy and amateur astronomers. The accuracy of the
algorithms used is not high enough for any navigational use, and there
may well be errors in the code, although I have checked the results
with other packages.</p>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">The algorithms shown here should be easily translated into most other 'macro languages', including<span>&nbsp;</span><code>AUTOLisp</code>, and<span>&nbsp;</span><code>SketchBasic</code><span>&nbsp;</span>which presents the possibility of automatic planisphere or diagramatic calendar construction.</p>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">The
modern business spreadsheet provides a powerful macro language, as well
as the calculational facilities on the spreadsheet grid itself. All
spreadsheets use radian measure for angles, and so the formulas used to
calculate the positions of planets and other objects become rather
long. If you want to make a table of positions, or an ephemeris for
some object, you can end up with a large and complex spreadsheet!
Worse, when you want to write a spreadsheet to do something different,
you have to copy bits of the original, and change references.</p>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">You
can write 'macros' to take a date, and produce a worksheet showing
(say) the position, aspect phase and paralactic angle of the Moon.
Macros do not usually 'hotlink' to the data, so for a new date you have
to run the macro again.</p>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">The
solution I adopt here is to use the facility in Excel for defining User
Functions. User functions have no side effects, you cannot write a
function which changes anything other than the cell which contains the
function. This means that I have to return coordinates one by one by
using an 'index' variable. As an example, to find the (geocentric)
Right Ascension in hours of the Moon on 1998 September 27th at 15:50 UT
would need two functions;</p>
<pre style="color: rgb(0, 0, 0); font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px;">           =moon(day2000(1998,9,27,15,50,0), 3)/15<br></pre>
<span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">in general, the function</span>
<pre style="color: rgb(0, 0, 0); font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px;">		   <br>           =moon(instant, index)<br></pre>
<span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">returns the spherical coordinates of the moon,</span>
<pre style="color: rgb(0, 0, 0); font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px;">	   <br>           index = 1 returns the distance in Earth radii<br>           index = 2 returns the declination in degrees<br>           index = 3 returns the right ascension in degrees<br></pre>
<span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">The spherical coordinates of any body are returned as;</span>
<pre style="color: rgb(0, 0, 0); font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px;">  index     equatorial          ecliptic (helio or geo centric)<br>    1       distance (a.u.)     distance (a.u.)<br>    2       declination         latitude<br>    3       right ascension     longitude<br></pre>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Note that the<span>&nbsp;</span><em>planet</em><span>&nbsp;</span>positions
are referred to the J2000.0 equinox and ecliptic, you will find
differences if you compare these positions with the apparent positions
(referred to equinox and ecliptic of date). These differences amount to
degrees for dates 50 years away from J2000.0. The Sun and Moon
positions are referred to mean ecliptic and equinox of date.</p>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">A
full tutorial on using these functions will appear when I have added
support for rigourous precession, some ready made 'macros' for common
tasks, and a range of precision choices. I also need to improve the
error trapping!</p>
<h2 style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-style: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;"><a name="twig02">Excel VBA code</a></h2>
<span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">[</span><a href="http://www.stargazing.net/kepler/astrofnc.html#twig00" style="font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Top</a><span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">]</span>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Below
you will find the Visual Basic for Applications source code for the set
of user defined functions. Before the definition of each function,
there is a brief comment describing the function.</p>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">To add these user defined functions to your spreadsheet, you should;</p>
<ul style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">
<li>Keep this page open in your browser</li><li>In the browser window, highlight all the text between the rows of * below</li><li>Select<span>&nbsp;</span><b>Edit | Copy</b><span>&nbsp;</span>from the browser<span>&nbsp;</span><b>Edit</b><span>&nbsp;</span>menu</li><li>open Excel 95 with a blank workbook</li><li>click on the<span>&nbsp;</span><b>Insert</b><span>&nbsp;</span>menu and select<span>&nbsp;</span><b>Insert | Macro | Module</b>.<br>A new module window should appear</li><li>click in the new VBA module window, and select<span>&nbsp;</span><b>Edit | Copy<span>&nbsp;</span></b>from the Excel<span>&nbsp;</span><b>edit</b><span>&nbsp;</span>menu</li><li>Save the new workbook</li><li>Switch to a blank worksheet, and type the formula<span>&nbsp;</span><code>=day2000(1998,9,27,0,0,0)</code><span>&nbsp;</span>into a cell, then press enter.<br>The cell value should be<span>&nbsp;</span><code>-461.5</code>, i.e. the number of days before J2000.0</li>
</ul>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">You may want to download the example spreadsheet (see<span>&nbsp;</span><a href="http://www.stargazing.net/kepler/astrofnc.html#twig03">below</a>),
which has all the functions plus some basic 'help' in the Function
Wizard, and some example spreadsheets showing how the functions are
used.</p>
<pre style="color: rgb(0, 0, 0); font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px;">'************************************************************************<br>'   A series of astronomical functions which may be<br>'   useful. These are all 'user defined functions'.<br>'   This means that you can paste them into spreadsheets<br>'   just like the normal functions - see Insert|function,<br>'   you can even use the function wizard.<br><br>'   The disadvantage<br>'   of Excel's 'user defined functions' is that they<br>'   can only return a single value, and the function cannot alter<br>'   the properties of the worksheet. Arguments you pass to<br>'   the VBA functions you define are passed 'by value'.<br><br>'   However, VBA defaults to 'passing arguments by reference'<br>'   when a function is called from another VBA function! This<br>'   can lead to a function giving a different answer when<br>'   called in the VBA module compared with when called in the<br>'   spreadsheet. Use the ByVal keyword to tag arguments you<br>'   change later in functions. See smoon() for an example.<br><br>'   define some numerical constants - these are not<br>'   accessible in the spreadsheet.<br><br>Public Const pi As Double = 3.14159265358979<br>Public Const tpi As Double = 6.28318530717958<br>Public Const degs  As Double = 57.2957795130823<br>Public Const rads As Double = 1.74532925199433E-02<br><br>'   The trig formulas working in degrees. This just<br>'   makes the spreadsheet formulas a bit easier to<br>'   read. DegAtan2() has had the arguments swapped<br>'   from the Excel order, so the order matches most<br>'   textbooks<br><br>Function DegSin(x As Double) As Double<br>    DegSin = Sin(rads * x)<br>End Function<br><br>Function DegCos(x As Double) As Double<br>    DegCos = Cos(rads * x)<br>End Function<br><br>Function DegTan(x As Double) As Double<br>    DegTan = Tan(rads * x)<br>End Function<br><br>Function DegArcsin(x As Double) As Double<br>    DegArcsin = degs * Application.Asin(x)<br>End Function<br><br>Function DegArccos(x As Double) As Double<br>     DegArccos = degs * Application.Acos(x)<br>End Function<br><br>Function DegArctan(x As Double) As Double<br>    DegArctan = degs * Atn(x)<br>End Function<br><br>Function DegAtan2(y As Double, x As Double) As Double<br>'   this returns the angle in the range 0 to 360<br>'   instead of -180 to 180 - and swaps the arguments<br>'   This format matches Meeus and Duffett-Smith<br>    DegAtan2 = degs * Application.Atan2(x, y)<br>    If DegAtan2 &lt; 0 Then DegAtan2 = DegAtan2 + 360<br>End Function<br><br>Private Function range2pi(x)<br>'<br>'   returns an angle x in the range 0 to two pi rads<br>'   This function is not available in the spreadsheet<br>'<br>range2pi = x - tpi * Int(x / tpi)<br>End Function<br><br>Private Function range360(x)<br>'<br>'   returns an angle x in the range 0 to 360<br>'   used to prevent the huge values of degrees<br>'   that you get from mean longitude formulas<br>'<br>'   this function is private to this module,<br>'   you won't find it in the Function Wizard,<br>'   and you can't use it on a spreadsheet.<br>'   If you want it on the spreadsheet, just remove<br>'   the 'private' keyword above.<br>'<br>range360 = x - 360 * Int(x / 360)<br>End Function<br><br>Function degdecimal(d, m, s)<br>'   converts from dms format to ddd format<br>    degdecimal = d + m / 60 + s / 3600<br>End Function<br><br>'<br>'   calander functions. jday and jcentury work on the Julian day numbers.<br>'   day2000 and century2000 work on the days to J2000 to reduce the<br>'   number of significant figures needed<br>'<br><br>Function jday(year As Integer, month As Integer, day As Integer, hour As Integer, _<br> min As Integer, sec As Double, Optional greg) As Double<br> '  returns julian day number given date in gregorian calender (greg=1)<br> '  or julian calendar (greg = 0). If greg ommited, then Gregorian is assumed.<br>    Dim a As Double<br>    Dim b As Integer<br>    a = 10000# * year + 100# * month + day<br>    If (a &lt; -47120101) Then MsgBox "Warning: date too early for algorithm"<br>    If (IsMissing(greg)) Then greg = 1<br>    If (month &lt;= 2) Then<br>        month = month + 12<br>        year = year - 1<br>    End If<br>    If (greg = 0) Then<br>        b = -2 + Fix((year + 4716) / 4) - 1179<br>    Else<br>        b = Fix(year / 400) - Fix(year / 100) + Fix(year / 4)<br>    End If<br>    a = 365# * year + 1720996.5<br>    jday = a + b + Fix(30.6001 * (month + 1)) + day + (hour + min / 60 + sec / 3600) / 24<br>End Function<br><br>Function jcentury(jd As Double) As Double<br>'   finds how many julian centuries since J2000 given<br>'    the julian day number. Not used below, I just add<br>'   a line into the subroutines which then take days<br>'   before J2000 as the time argument<br>    jcentury = (jd - 2451545) / 36525<br>End Function<br><br>Function day2000(year As Integer, month As Integer, day As Integer, hour As Integer, _<br> min As Integer, sec As Double, Optional greg) As Double<br> '  returns days before J2000.0 given date in gregorian calender (greg=1)<br> '  or julian calendar (greg = 0). If you don't provide a value for greg,<br> '  then assumed Gregorian calender<br>    Dim a As Double<br>    Dim b As Integer<br>    If (IsMissing(greg)) Then greg = 1<br>    a = 10000# * year + 100# * month + day<br>    If (month &lt;= 2) Then<br>        month = month + 12<br>        year = year - 1<br>    End If<br>    If (greg = 0) Then<br>        b = -2 + Fix((year + 4716) / 4) - 1179<br>    Else<br>        b = Fix(year / 400) - Fix(year / 100) + Fix(year / 4)<br>    End If<br>    a = 365# * year - 730548.5<br>    day2000 = a + b + Fix(30.6001 * (month + 1)) + day + (hour + min / 60 + sec / 3600) / 24<br>End Function<br><br>Function century2000(day2000 As Double) As Double<br>'   finds how many julian centuries since J2000 given<br>'   the days before J2000<br>    century2000 = day2000 / 36525<br>End Function<br><br>'<br>'   Conversion to and from rectangular and polar coordinates.<br>'   X,Y,Z form a left handed set of axes, and r is the radius vector<br>'   of the point from the origin. Theta is the elevation angle of<br>'   r with the XY plane, and phi is the angle anti-clockwise from the<br>'   X axis and the projection of r in the X,Y plane.<br>'<br>'   in astronomical coordinate systems,<br>'<br>'   item    equatorial          ecliptic (helio or geo centric)<br>'   z       celestial pole      ecliptic pole<br>'   x,y     equatorial plane    ecliptic<br>'   theta   declination         latitude<br>'   phi     right ascension     longitude<br>'<br><br>Function rectangular(r As Double, theta As Double, phi As Double, _<br> index As Integer) As Double<br> '  takes spherical coordinates in degrees and returns the rectangular<br> '  coordinate shown by index, 1 = x, 2 = y, 3 = z<br> '<br> '  x = r.cos(theta).cos(phi)<br> '  y = r.cos(theta).sin(phi)<br> '  z = r.sin(theta)<br> '<br>    Dim r_cos_theta As Double<br>    r_cos_theta = r * DegCos(theta)<br>    Select Case index<br>        Case 1<br>            rectangular = r_cos_theta * DegCos(phi) 'returns x coord<br>        Case 2<br>            rectangular = r_cos_theta * DegSin(phi) 'returns y coord<br>        Case 3<br>            rectangular = r * DegSin(theta)         'returns z coord<br>    End Select<br>End Function<br><br>Function rlength(x As Double, y As Double, z As Double) As Double<br>'   returns radius vector given the rectangular coords<br>    rlength = Sqr(x * x + y * y + z * z)<br>End Function<br><br>Function spherical(x As Double, y As Double, z As Double, index As Integer) As Double<br>'<br>'   Takes the rectangular coordinates and returns the shperical<br>'   coordinate selected by index - 1 = r, 2 = theta, 3 = phi<br>'<br>'   r = sqrt(x*x + y*y + z*z)<br>'   tan(phi) = y/x - use atan2 to get in correct quadrant<br>'   tan(theta) = z/sqrt(x*x + y*y) - likewise<br>'<br>    Dim rho As Double<br>    rho = x * x + y * y<br>        Select Case index<br>        Case 1<br>            spherical = Sqr(rho + z * z)    'returns r<br>        Case 2<br>            rho = Sqr(rho)<br>            spherical = DegArctan(z / rho)    'returns theta<br>        Case 3<br>            rho = Sqr(rho)<br>            spherical = DegAtan2(y, x)      'returns phi<br>    End Select<br>End Function<br><br>'<br>'   returns the obliquity of the ecliptic in degrees given the number<br>'   of julian centuries from J2000<br>'<br>'   Most textbooks will give the IAU formula for the obliquity of<br>'   the ecliptic below;<br>'<br>'   obliquity = 23.43929111 - 46.8150"t - 0.00059"t^2 + 0.001813*t^3<br>'<br>'   as explained in Meeus or Numerical Recipes, it is more efficient and<br>'   accurate to use the nested brackets shown in the function. If you<br>'   multiply the brackets out, they come to the same.<br>'<br>Function obliquity(d As Double) As Double<br>    Dim t As Double<br>    t = d / 36525   'julian centuries since J2000.0<br>    obliquity = 23.43929111 - (46.815 + (0.00059 - 0.001813 * t) * t) * t / 3600#<br>End Function<br><br>'<br>'   functions for converting between equatorial and ecliptic<br>'   geocentric coordinates, both polar and rectangular coords<br>'<br><br>'<br>'   Converts geocentric ecliptic coordinates into geocentric equatorial<br>'   coordinates. Expects rectangular coordinates.<br>'<br>Function requatorial(x As Double, y As Double, z As Double, d As Double, _<br> index As Integer) As Double<br>    Dim obl As Double<br>    obl = obliquity(d)<br>    Select Case index<br>        Case 1<br>            requatorial = x<br>        Case 2<br>            requatorial = y * DegCos(obl) - z * DegSin(obl)<br>        Case 3<br>            requatorial = y * DegSin(obl) + z * DegCos(obl)<br>    End Select<br>End Function<br>'<br>'   converts geocentric equatorial coordinates into geocentric ecliptic<br>'   coordinates. Expects rectangular coordinates.<br>'<br>Function recliptic(x As Double, y As Double, z As Double, d As Double, _<br> index As Integer) As Double<br>    Dim obl As Double<br>    obl = obliquity(d)<br>    Select Case index<br>        Case 1<br>            recliptic = x<br>        Case 2<br>            recliptic = y * DegCos(obl) + z * DegSin(obl)<br>        Case 3<br>            recliptic = -y * DegSin(obl) + z * DegCos(obl)<br>    End Select<br>End Function<br><br>'<br>'   Converts geocentric ecliptic coordinates into geocentric equatorial<br>'   coordinates. Expects spherical coordinates.<br>'<br>Function sequatorial(r As Double, theta As Double, phi As Double, d As Double, _<br> index As Integer) As Double<br>    Dim x As Double, y As Double, z As Double<br>    x = rectangular(r, theta, phi, 1)<br>    y = rectangular(r, theta, phi, 2)<br>    z = rectangular(r, theta, phi, 3)<br>    sequatorial = spherical(requatorial(x, y, z, d, 1), requatorial(x, y, z, d, 2), _<br>     requatorial(x, y, z, d, 3), index)<br>End Function<br><br>'   Converts geocentric equatorial coordinates into geocentric ecliptic<br>'   coordinates. Expects spherical coordinates.<br>'<br>Function secliptic(r As Double, theta As Double, phi As Double, d As Double, _<br> index As Integer) As Double<br>    Dim x As Double, y As Double, z As Double<br>    x = rectangular(r, theta, phi, 1)<br>    y = rectangular(r, theta, phi, 2)<br>    z = rectangular(r, theta, phi, 3)<br>    secliptic = spherical(recliptic(x, y, z, d, 1), recliptic(x, y, z, d, 2), _<br>    recliptic(x, y, z, d, 3), index)<br>End Function<br>'<br>'   precession (approximate formula) from Meeus Algorithms p124<br>'   d1 is the epoch to precess from, d2 is the epoch to precess<br>'   to, and index selects ra or dec. The function takes optional<br>'   arguments dra and ddec to represent the proper motion of a<br>'   star in seconds of arc per year.<br>'<br>'   ra and dec must BOTH be in decimal degrees. This formula is<br>'   different to the one elsewhere on the Web site!<br>'<br>Function precess(d1 As Double, d2 As Double, dec As Double, _<br>                    ra As Double, index As Integer, _<br>                    Optional ddec, Optional dra) As Double<br>Dim m As Double, n As Double, t As Double<br>If (IsMissing(dra)) Then dra = 0<br>If (IsMissing(ddec)) Then ddec = 0<br>t = d1 / 36525          'years since J2000<br>m = 0.01281233333333 + 0.00000775 * t<br>n = 0.005567527777778 - 2.361111111111E-06 * t<br>t = (d2 - d1) / 365.25   'difference in julian _years_, not centuries!<br>Select Case index<br>    Case 1      'dec<br>        precess = dec + (n * DegCos(ra) + ddec / 3600) * t<br>    Case 2      'ra<br>        precess = ra + (m + n * DegSin(ra) * DegTan(dec) + dra / 3600) * t<br>End Select<br>End Function<br>'<br>'   The function below returns the geocentric ecliptic coordinates of the sun<br>'   to an accuracy corresponding to about 0.01 degree over<br>'   100 years either side of J2000. Coordinates returned<br>'   in spherical form. From page C24 of the 1996 Astronomical<br>'   Alamanac. Comparing accuracy with Planeph, a DOS ephemeris<br>'   by Chapront, we get;<br>'<br>'   Sun error<br>'                       RA sec    DEC arcsec<br>'   Max within 3 year     0.6        8.9<br>'   Min within 3 year    -2.1       -8.2<br>'   Max within 10 year    0.6       10.9<br>'   Min within 10 year   -2.6      -12.5<br>'   Max within 50 year    1.0       16.8<br>'   Min within 50 year   -2.9      -16.1<br>'<br>'   Error = C24 low precision method - Planeph<br>'<br>'   Note: Planeph was set to give output referred to mean<br>'         ecliptic and equinox of date.<br>'<br>'   The accuracy of this routine is good enough for sunrise<br>'   and shadow direction calculations, and for referring<br>'   low precision planetary and comet positions to the Earth,<br>'   but is no good for accurate coordinate conversion or<br>'   for eclipse or occultation use.<br>'<br>'   Coordinates are referred to the ecliptic and mean equinox of date<br>'<br>Function ssun(d As Double, index As Integer) As Double<br>    Dim g As Double<br>    Dim l As Double<br>    g = range360(357.528 + 0.9856003 * d)<br>    l = range360(280.461 + 0.9856474 * d)<br>    Select Case index<br>        Case 1<br>            ' radius vector of Sun<br>            ssun = 1.00014 - 0.01671 * DegCos(g) - 0.00014 * DegCos(2 * g)<br>        Case 2<br>            ssun = 0    'ecliptic latitude of Sun is zero to very good accuracy<br>        Case 3<br>            'longitude of Sun<br>            ssun = range360(l + 1.915 * DegSin(g) + 0.02 * DegSin(2 * g))<br>    End Select<br>End Function<br><br>'   returns the geocentric ecliptic coordinates of the sun<br>'   to an accuracy corresponding to about 0.01 degree over<br>'   100 years either side of J2000. Assumes ssun() exists.<br>'<br>'   rectangular form is easier for converting positions from helio-<br>'   centric to geocentric, but beware low accuracy (roughly 0.01 degree)<br>'   of values<br>'<br>Function rsun(d As Double, index As Integer) As Double<br>    Dim x As Double<br>    Dim y As Double<br>    Dim z As Double<br>    rsun = rectangular(ssun(d, 1), ssun(d, 2), ssun(d, 3), index)<br>End Function<br>'<br>'   sun() returns the geocentric ra and dec and radius vector<br>'   of the moon - calls smoon three times, and sequatorial<br>'   three times - sequatorial calls rectangular three times<br>'   each!<br>'<br>Function sun(d As Double, index As Integer) As Double<br>    sun = sequatorial(ssun(d, 1), ssun(d, 2), ssun(d, 3), d, index)<br>End Function<br>'<br>'   The function below implements Paul Schlyter's simplification<br>'   of van Flandern and Pulkkinen's method for finding the geocentric<br>'   ecliptic positions of the Moon to an accuracy of about 1 to 4 arcmin.<br>'<br>'   I can probably reduce the number of variables, and there must<br>'   be a quicker way of declaring variables!<br>'<br>'   The VBA trig functions have been used throughout for speed,<br>'   note how the atan function returns values in domain -pi to pi<br>'<br>Function smoon(ByVal d As Double, index As Integer) As Double<br>    Dim Nm As Double, im As Double, wm As Double, am As Double, ecm As Double, _<br>    Mm As Double, em As Double, Ms As Double, ws As Double, xv As Double, _<br>    yv As Double, vm As Double, rm As Double, x As Double, y As Double, _<br>    z As Double, lon As Double, lat As Double, ls As Double, lm As Double, _<br>    dm As Double, F As Double, dlong As Double, dlat As Double<br>    '   Paul's routine uses a slightly different definition of<br>    '   the day number - I adjust for it below. Remember that VBA<br>    '   defaults to 'pass by reference' so this change in d<br>    '   will be visible to other functions unless you set d to 'ByVal'<br>    '   to force it to be passed by value!<br>    d = d + 1.5<br>    '   moon elements<br>    Nm = range360(125.1228 - 0.0529538083 * d) * rads<br>    im = 5.1454 * rads<br>    wm = range360(318.0634 + 0.1643573223 * d) * rads<br>    am = 60.2666  '(Earth radii)<br>    ecm = 0.0549<br>    Mm = range360(115.3654 + 13.0649929509 * d) * rads<br>    '   position of Moon<br>    em = Mm + ecm * Sin(Mm) * (1# + ecm * Cos(Mm))<br>    xv = am * (Cos(em) - ecm)<br>    yv = am * (Sqr(1# - ecm * ecm) * Sin(em))<br>    vm = Application.Atan2(xv, yv)<br>    '   If vm &lt; 0 Then vm = tpi + vm<br>    rm = Sqr(xv * xv + yv * yv)<br>    x = rm * (Cos(Nm) * Cos(vm + wm) - Sin(Nm) * Sin(vm + wm) * Cos(im))<br>    y = rm * (Sin(Nm) * Cos(vm + wm) + Cos(Nm) * Sin(vm + wm) * Cos(im))<br>    z = rm * (Sin(vm + wm) * Sin(im))<br>    '   moons geocentric long and lat<br>    lon = Application.Atan2(x, y)<br>    If lon &lt; 0 Then lon = tpi + lon<br>    lat = Atn(z / Sqr(x * x + y * y))<br>    '   mean longitude of sun<br>    ws = range360(282.9404 + 0.0000470935 * d) * rads<br>    Ms = range360(356.047 + 0.9856002585 * d) * rads<br>    '   perturbations<br>    '   first calculate arguments below,<br>    'Ms, Mm             Mean Anomaly of the Sun and the Moon<br>    'Nm                 Longitude of the Moon's node<br>    'ws, wm             Argument of perihelion for the Sun and the Moon<br>    ls = Ms + ws       'Mean Longitude of the Sun  (Ns=0)<br>    lm = Mm + wm + Nm  'Mean longitude of the Moon<br>    dm = lm - ls        'Mean elongation of the Moon<br>    F = lm - Nm        'Argument of latitude for the Moon<br>    ' then add the following terms to the longitude<br>    ' note amplitudes are in degrees, convert at end<br>    Select Case index<br>        Case 1  '   distance terms earth radii<br>            rm = rm - 0.58 * Cos(Mm - 2 * dm)<br>            rm = rm - 0.46 * Cos(2 * dm)<br>            smoon = rm<br>        Case 2  '   latitude terms<br>            dlat = -0.173 * Sin(F - 2 * dm)<br>            dlat = dlat - 0.055 * Sin(Mm - F - 2 * dm)<br>            dlat = dlat - 0.046 * Sin(Mm + F - 2 * dm)<br>            dlat = dlat + 0.033 * Sin(F + 2 * dm)<br>            dlat = dlat + 0.017 * Sin(2 * Mm + F)<br>            smoon = lat * degs + dlat<br>        Case 3  '   longitude terms<br>            dlon = -1.274 * Sin(Mm - 2 * dm)        '(the Evection)<br>            dlon = dlon + 0.658 * Sin(2 * dm)       '(the Variation)<br>            dlon = dlon - 0.186 * Sin(Ms)           '(the Yearly Equation)<br>            dlon = dlon - 0.059 * Sin(2 * Mm - 2 * dm)<br>            dlon = dlon - 0.057 * Sin(Mm - 2 * dm + Ms)<br>            dlon = dlon + 0.053 * Sin(Mm + 2 * dm)<br>            dlon = dlon + 0.046 * Sin(2 * dm - Ms)<br>            dlon = dlon + 0.041 * Sin(Mm - Ms)<br>            dlon = dlon - 0.035 * Sin(dm)           '(the Parallactic Equation)<br>            dlon = dlon - 0.031 * Sin(Mm + Ms)<br>            dlon = dlon - 0.015 * Sin(2 * F - 2 * dm)<br>            dlon = dlon + 0.011 * Sin(Mm - 4 * dm)<br>            smoon = lon * degs + dlon<br>    End Select<br>End Function<br>'<br>'   rmoon uses smoon to return the geocentric ecliptic rectangular coordinates<br>'   of the moon to lowish accuracy.<br>'<br>'<br>Function rmoon(d As Double, index As Integer) As Double<br>    rmoon = rectangular(smoon(d, 1), smoon(d, 2), smoon(d, 3), index)<br>End Function<br>'<br>'   moon() returns the geocentric ra and dec and radius vector<br>'   of the moon - calls smoon three times, and sequatorial<br>'   three times - sequatorial calls rectangular three times<br>'   each!<br>'<br>Function moon(d As Double, index As Integer) As Double<br>Dim nigel As Double<br>    If index = 4 Then<br>        nigel = smoon(d, 2)<br>        moon = d<br>    Else<br>        moon = sequatorial(smoon(d, 1), smoon(d, 2), smoon(d, 3), d, index)<br>    End If<br>End Function<br>'<br>'   Solutions of the kepler equation using a Newton's method approach.<br>'   See Meeus or Duffett-Smith (calculator)<br>'<br>Function kepler(m As Double, ecc As Double, Optional eps)<br>'   solves the equation e - ecc*sin(e) = m for e given an m<br>'   returns the value of the 'true anomaly' in rads<br>'   m  -  the 'mean anomaly' in rads<br>'   ecc - the eccentricity of the orbit<br>'   eps - the precision parameter - solution will be<br>'         within 10^-eps of the true value.<br>'         don't set eps above 14, as convergence<br>'         can't be guaranteed. If not specified, then<br>'         taken as 10^-8 or 10 nano radians!<br>'<br>    Dim delta As Double, e As Double, v As Double<br>    <br>    e = m               'first guess<br>    delta = 0.05        'set delta equal to a dummy value<br>    If (IsMissing(eps)) Then eps = 8                'if no eps then assume 10^-8<br>    Do While Abs(delta) &gt;= 10 ^ -eps             'converged?<br>        delta = e - ecc * Sin(e) - m                'new error<br>        e = e - delta / (1 - ecc * Cos(e))          'corrected guess<br>    Loop<br>    v = 2 * Atn(((1 + ecc) / (1 - ecc)) ^ 0.5 * Tan(0.5 * e))<br>    If v &lt; 0 Then v = v + tpi<br>    kepler = v<br>End Function<br>'<br>'   The functions below return the heliocentric ecliptic coordinates<br>'   of the planets to an accuracy of a few minutes of arc. The coordinates<br>'   are referred to the equinox of J2000.0<br>'<br>'   The functions use a simple Kepler ellipse, but with<br>'   mean elements which change slightly with the time since<br>'   J2000. See 'Explanatory supplement to the Astronomical<br>'   Almanac' 1992, page 316, table 5.8.1. Worst case errors<br>'   over the period 1800 - 2050 AD in arcsec are below;<br>'<br>'                    Ra      Dec<br>'   Mercury          20"      5"<br>'   Venus            20"      5"<br>'   Earth            20"      5"<br>'   Mars             25"     30"<br>'   Jupiter         300"    100"<br>'   Saturn          600"    200"<br>'   Uranus           60"     25"<br>'   Neptune          40"     20"<br>'   Pluto            40"     10"<br>'<br><br>'<br>'   The rplanet() function returns the ecliptic heliocentric coordinates<br>'   of each of the major planets. You select the planet you want using<br>'   pnumber, and the coordinate you want with index as usual.<br>'<br>Function rplanet(d As Double, pnumber As Integer, index As Integer) As Double<br>    Dim x As Double, y As Double, z As Double, v As Double, m As Double, _<br>    i As Double, o As Double, p As Double, a As Double, e As Double, _<br>    l As Double, r As Double<br>    '<br>    '   get elements of the planet<br>    '<br>    element i, o, p, a, e, l, d, pnumber<br>    '<br>    '   position of planet in its orbit<br>    '<br>    m = range2pi(l - p)<br>    v = kepler(m, e, 8)<br>    r = a * (1 - e * e) / (1 + e * Cos(v))<br>    '<br>    '   heliocentric rectangular coordinates of planet<br>    '<br>    Select Case index<br>    Case 1      'x coordinate<br>        rplanet = r * (Cos(o) * Cos(v + p - o) - Sin(o) * Sin(v + p - o) * Cos(i))<br>    Case 2      'y coordinate<br>        rplanet = r * (Sin(o) * Cos(v + p - o) + Cos(o) * Sin(v + p - o) * Cos(i))<br>    Case 3      'z coordinate<br>        rplanet = r * (Sin(v + p - o) * Sin(i))<br>    End Select<br>End Function<br>'<br>'<br>'   The planet() function returns the equatorial geocentric coordinates<br>'   of each of the major planets. You select the planet you want using<br>'   pnumber, and the coordinate you want with index as usual. Code is<br>'   duplicated from rplanet() to reduce the number of calls to kepler()<br>'<br>'<br>Function planet(d As Double, pnumber As Integer, index As Integer) As Double<br>    Dim x As Double, y As Double, z As Double, v As Double, m As Double, _<br>    i As Double, o As Double, p As Double, a As Double, e As Double, _<br>    l As Double, r As Double, xe As Double, ye As Double, ze As Double, _<br>    s1 As Double, si As Double, so As Double, c1 As Double, ci As Double, _<br>    co As Double<br>    '<br>    '   elements of planet - select from the values<br>    '<br>    element i, o, p, a, e, l, d, pnumber<br>    '<br>    '   position of planet in its orbit<br>    '<br>    m = range2pi(l - p)<br>    v = kepler(m, e, 8)<br>    r = a * (1 - e * e) / (1 + e * Cos(v))<br>    '<br>    '   heliocentric rectangular coordinates of planet<br>    '<br>    s1 = Sin(v + p - o)<br>    si = Sin(i)<br>    so = Sin(o)<br>    c1 = Cos(v + p - o)<br>    ci = Cos(i)<br>    co = Cos(o)<br>    x = r * (co * c1 - so * s1 * ci)<br>    y = r * (so * c1 + co * s1 * ci)<br>    z = r * (s1 * si)<br>    '<br>    '   elements of earth (reusing variables)<br>    '<br>    element i, o, p, a, e, l, d, 3<br>    '<br>    '   position of earth in its orbit<br>    '<br>    m = range2pi(l - p)<br>    v = kepler(m, e, 8)<br>    r = a * (1 - e * e) / (1 + e * Cos(v))<br>    '<br>    '   heliocentric rectangular coordinates of earth<br>    '<br>    s1 = Sin(v + p - o)<br>    si = Sin(i)<br>    so = Sin(o)<br>    c1 = Cos(v + p - o)<br>    ci = Cos(i)<br>    co = Cos(o)<br>    xe = r * (co * c1 - so * s1 * ci)<br>    ye = r * (so * c1 + co * s1 * ci)<br>    ze = r * (s1 * si)<br>    '<br>    '   convert to geocentric rectangular coordinates<br>    '<br>    x = x - xe<br>    y = y - ye<br>    '   z = z<br>    '<br>    '   rotate around x axis from ecliptic to equatorial coords<br>    '<br>    ecl = 23.429292 * rads      'value for J2000.0 frame<br>    xe = x<br>    ye = y * Cos(ecl) - z * Sin(ecl)<br>    ze = y * Sin(ecl) + z * Cos(ecl)<br>    '<br>    '   find the RA and DEC from the rectangular equatorial coords<br>    '<br>    Select Case index<br>    Case 3<br>        ' RA in degrees<br>        planet = Application.Atan2(xe, ye) * degs<br>        If planet &lt; 0 Then planet = 360 + planet<br>    Case 2<br>        ' DEC in degrees<br>        planet = Atn(ze / Sqr(xe * xe + ye * ye)) * degs<br>    Case 1<br>        ' Radius vector in au<br>        planet = Sqr(xe * xe + ye * ye + ze * ze)<br>    End Select<br>End Function<br>'<br>'   The subroutine below replaces the values of i,o,p,a,e,L<br>'   with the values for the planet selected by pnum. You could<br>'   always add planet like objects, but watch the value of<br>'   the inclination i. The method used in planet is only<br>'   good for orbits 'near' the ecliptic.<br>'<br>Sub element(i As Double, o As Double, p As Double, _<br>            a As Double, e As Double, l As Double, _<br>            ByVal d As Double, ByVal pnum As Integer)<br>    Select Case pnum<br>        Case 1          'mercury<br>            i = (7.00487 - 0.000000178797 * d) * rads<br>            o = (48.33167 - 0.0000033942 * d) * rads<br>            p = (77.45645 + 0.00000436208 * d) * rads<br>            a = 0.38709893 + 1.80698E-11 * d<br>            e = 0.20563069 + 0.000000000691855 * d<br>            l = range2pi(rads * (252.25084 + 4.092338796 * d))<br>        Case 2          'venus<br>            i = (3.39471 - 0.0000000217507 * d) * rads<br>            o = (76.68069 - 0.0000075815 * d) * rads<br>            p = (131.53298 - 0.000000827439 * d) * rads<br>            a = 0.72333199 + 2.51882E-11 * d<br>            e = 0.00677323 - 0.00000000135195 * d<br>            l = range2pi(rads * (181.97973 + 1.602130474 * d))<br>        Case 3          'earth<br>            i = (0.00005 - 0.000000356985 * d) * rads<br>            o = (-11.26064 - 0.00013863 * d) * rads<br>            p = (102.94719 + 0.00000911309 * d) * rads<br>            a = 1.00000011 - 1.36893E-12 * d<br>            e = 0.01671022 - 0.00000000104148 * d<br>            l = range2pi(rads * (100.46435 + 0.985609101 * d))<br>        Case 4          'mars<br>            i = (1.85061 - 0.000000193703 * d) * rads<br>            o = (49.57854 - 0.0000077587 * d) * rads<br>            p = (336.04084 + 0.00001187 * d) * rads<br>            a = 1.52366231 - 0.000000001977 * d<br>            e = 0.09341233 - 0.00000000325859 * d<br>            l = range2pi(rads * (355.45332 + 0.524033035 * d))<br>        Case 5          'jupiter<br>            i = (1.3053 - 0.0000000315613 * d) * rads<br>            o = (100.55615 + 0.00000925675 * d) * rads<br>            p = (14.75385 + 0.00000638779 * d) * rads<br>            a = 5.20336301 + 0.0000000166289 * d<br>            e = 0.04839266 - 0.00000000352635 * d<br>            l = range2pi(rads * (34.40438 + 0.083086762 * d))<br>        Case 6          'saturn<br>            i = (2.48446 + 0.0000000464674 * d) * rads<br>            o = (113.71504 - 0.0000121 * d) * rads<br>            p = (92.43194 - 0.0000148216 * d) * rads<br>            a = 9.53707032 - 0.0000000825544 * d<br>            e = 0.0541506 - 0.0000000100649 * d<br>            l = range2pi(rads * (49.94432 + 0.033470629 * d))<br>        Case 7          'uranus<br>            i = (0.76986 - 0.0000000158947 * d) * rads<br>            o = (74.22988 + 0.0000127873 * d) * rads<br>            p = (170.96424 + 0.0000099822 * d) * rads<br>            a = 19.19126393 + 0.0000000416222 * d<br>            e = 0.04716771 - 0.00000000524298 * d<br>            l = range2pi(rads * (313.23218 + 0.011731294 * d))<br>        Case 8          'neptune<br>            i = (1.76917 - 0.0000000276827 * d) * rads<br>            o = (131.72169 - 0.0000011503 * d) * rads<br>            p = (44.97135 - 0.00000642201 * d) * rads<br>            a = 30.06896348 - 0.0000000342768 * d<br>            e = 0.00858587 + 0.000000000688296 * d<br>            l = range2pi(rads * (304.88003 + 0.0059810572 * d))<br>        Case 9          'pluto<br>            i = (17.14175 + 0.0000000841889 * d) * rads<br>            o = (110.30347 - 0.0000002839 * d) * rads<br>            p = (224.06676 - 0.00000100578 * d) * rads<br>            a = 39.48168677 - 0.0000000210574 * d<br>            e = 0.24880766 + 0.00000000177002 * d<br>            l = range2pi(rads * (238.92881 + 3.97557152635181E-03 * d))<br>    End Select<br>End Sub<br>'****************************************************************<br></pre>
<h2 style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-style: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;"><a name="twig03">Download example spreadsheet</a></h2>
<span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">[</span><a href="http://www.stargazing.net/kepler/astrofnc.html#twig00" style="font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Top</a><span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">]</span>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">You can download an Excel 95 spreadsheet with a VBA module containing all the functions above, and some example applications, as<span>&nbsp;</span><code><a href="http://www.stargazing.net/kepler/astrovba.zip">astrovba.zip</a><span>&nbsp;</span>(32 Kb)</code>.</p>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Below is a list of all the Excel spreadsheets available from this Web site;</p>
<ul style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">
<li><a href="http://www.stargazing.net/kepler/astrovba.zip">astrovba.zip (32 Kb)</a><span>&nbsp;</span>- the user functions described above, with 'help' available in the function wizard and some example worksheets</li><li><a href="http://www.stargazing.net/kepler/alt1997.zip">alt1997.zip (6 Kb)</a><span>&nbsp;</span>- conversion to Horizon coords</li><li><a href="http://www.stargazing.net/kepler/moonpos.zip">moonpos.zip (19 Kb)</a><span>&nbsp;</span>- position of Moon using Meeus algorithms</li><li><a href="http://www.stargazing.net/kepler/oscxls.zip">oscxls.zip (10 Kb)</a><span>&nbsp;</span>- planet positions using osculating elements and Kepler ellipses</li>
</ul>
<span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">Note that none of the other spreadsheets employ the user functions described here. A look at<span>&nbsp;</span></span><code style="color: rgb(0, 0, 0); font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">oscxls.zip</code><span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">, mercury worksheet, cell G14 will convince you that user functions can make spreadsheets neater to write and easier to follow!</span>
<h2 style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-style: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;"><a name="twig04">References</a></h2>
<span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">[</span><a href="http://www.stargazing.net/kepler/astrofnc.html#twig00" style="font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Top</a><span style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; background-color: rgb(255, 255, 255); display: inline ! important; float: none;">]</span>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Meeus, Jean<br><cite>Astronomical Algorithms</cite><br>Willmann-Bell<br>1st English edition, 1991<br>ISBN 0-943396-35-2</p>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Duffett-Smith, Peter<br><i>Practical Astronomy with your calculator</i><br>Cambridge University Press<br>3rd edition 1988<br>ISBN 0-521-35699-7</p>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Montenbruck, Pfleger<br><i>Astronomy on the personal computer</i><br>Springer<br>3rd edition 1988<br>ISBN 3-540-63521-1</p>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">[<a href="http://www.stargazing.net/kepler/index.html">Root</a>]</p>
<p style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">Last Modified 27th February 1999<br>Keith Burnett<br></p>
<address style="color: rgb(0, 0, 0); font-family: &quot;Times New Roman&quot;; font-size: medium; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;">keith@xylem.demon.co.uk</address>
<br class="Apple-interchange-newline">

  

</body></html>